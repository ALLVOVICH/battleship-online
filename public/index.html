<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Морской бой</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body { font-family: sans-serif; background:#0b132b; color:white; text-align:center }
.grid { display:grid; grid-template-columns:repeat(10,30px); gap:2px; margin:10px auto }
.cell { width:30px; height:30px; background:#1c2541; cursor:pointer }
.hit { background:red }
.miss { background:#3a86ff }
</style>
</head>
<body>

<h2 id="status">Создай или войди в комнату</h2>

<button onclick="create()">Создать</button>
<input id="code" placeholder="Код">
<button onclick="join()">Войти</button>

<h3 id="room"></h3>

<div id="enemy" class="grid"></div>

<button onclick="randomShips()">Случайная расстановка</button>
<button onclick="rematch()">Реванш</button>

<script>
const socket = io();
let roomCode = "";
let myShips = [];

function create() {
  socket.emit("createRoom");
}

function join() {
  roomCode = code.value;
  socket.emit("joinRoom", roomCode);
}

socket.on("roomCode", c => {
  roomCode = c;
  room.innerText = "Код комнаты: " + c;
});

socket.on("startPlacement", () => {
  status.innerText = "Расставь корабли";
});

function randomShips() {
  myShips = [];
  while (myShips.length < 20) {
    const c = Math.floor(Math.random()*100);
    if (!myShips.includes(c)) myShips.push(c);
  }
  socket.emit("setBoard", {
    code: roomCode,
    ships: myShips.map(c => `${Math.floor(c/10)},${c%10}`)
  });
}

function drawEnemy() {
  enemy.innerHTML = "";
  for (let i=0;i<100;i++){
    const d = document.createElement("div");
    d.className="cell";
    d.onclick=()=>shot(i);
    d.id="e"+i;
    enemy.appendChild(d);
  }
}

function shot(i){
  socket.emit("shot", { code: roomCode, cell:`${Math.floor(i/10)},${i%10}` });
}

socket.on("yourTurn", ()=>{
  status.innerText="Твой ход";
  drawEnemy();
});

socket.on("shotResult", ({cell, hit})=>{
  const [x,y]=cell.split(",");
  const i=x*10+ +y;
  document.getElementById("e"+i).classList.add(hit?"hit":"miss");
});

socket.on("enemyShot", ()=>status.innerText="Ход противника");

socket.on("win", ()=>alert("ПОБЕДА"));
socket.on("lose", ()=>alert("ПОРАЖЕНИЕ"));
socket.on("restart", ()=>location.reload());

function rematch(){
  socket.emit("rematch", roomCode);
}
</script>
</body>
</html>
